# Commands definition file
# Format (pipe-separated):
# NAMESPACE|NAME|FUNC_NAME|TYPES(space-separated)|JS_ACTION
# Lines starting with '#' are comments.

# ------------------------------------------------------------------------------
# DOM
# ------------------------------------------------------------------------------
dom|CREATE_ELEMENT|create_element|string:id string:tag|{ const el = document.createElement(tag); elements.set(id, el); }
dom|SET_ATTRIBUTE|set_attribute|string:id string:name string:value|{ const el = elements.get(id); if(!el){ console.warn('set_attribute: unknown element id', id); continue; } el.setAttribute(name, value); }
dom|GET_ATTRIBUTE|get_attribute|string:id string:name|{ /* TODO: Return values not supported yet */ }
dom|APPEND_CHILD|append_child|string:parent_id string:child_id|{ const parent = elements.get(parent_id); const child = elements.get(child_id); if(!parent || !child){ console.warn('append_child: unknown ids', parent_id, child_id); continue; } parent.appendChild(child); }
dom|REMOVE_ELEMENT|remove_element|string:id|{ const el = elements.get(id); if(!el){ console.warn('remove_element: unknown element id', id); continue; } el.remove(); elements.delete(id); }
dom|SET_INNER_HTML|set_inner_html|string:id string:html|{ const el = elements.get(id); if(el) el.innerHTML = html; }
dom|SET_INNER_TEXT|set_inner_text|string:id string:text|{ const el = elements.get(id); if(el) el.innerText = text; }
dom|ADD_CLASS|add_class|string:id string:cls|{ const el = elements.get(id); if(el) el.classList.add(cls); }
dom|REMOVE_CLASS|remove_class|string:id string:cls|{ const el = elements.get(id); if(el) el.classList.remove(cls); }

# ------------------------------------------------------------------------------
# CANVAS 2D
# ------------------------------------------------------------------------------
canvas|CREATE_CANVAS|create_canvas|string:id float32:width float32:height|{ const c = document.createElement('canvas'); c.id = id; c.width = width; c.height = height; canvases.set(id, c); elements.set(id, c); }
canvas|SET_SIZE|set_size|string:id float32:width float32:height|{ const c = canvases.get(id); if(c) { c.width = width; c.height = height; } }
canvas|SET_FILL_STYLE|set_fill_style|string:id uint8:r uint8:g uint8:b|{ const cv = canvases.get(id); if(!cv){ console.warn('set_fill_style: unknown canvas id', id); continue; } cv.getContext('2d').fillStyle = `rgb(${r},${g},${b})`; }
canvas|SET_FILL_STYLE_STR|set_fill_style_str|string:id string:color|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').fillStyle = color; }
canvas|FILL_RECT|fill_rect|string:id float32:x float32:y float32:w float32:h|{ const cv = canvases.get(id); if(!cv){ console.warn('fill_rect: unknown canvas id', id); continue; } cv.getContext('2d').fillRect(x, y, w, h); }
canvas|CLEAR_RECT|clear_rect|string:id float32:x float32:y float32:w float32:h|{ const cv = canvases.get(id); if(!cv){ console.warn('clear_canvas: unknown canvas id', id); continue; } cv.getContext('2d').clearRect(x, y, w, h); }
canvas|STROKE_RECT|stroke_rect|string:id float32:x float32:y float32:w float32:h|{ const cv = canvases.get(id); if(!cv){ console.warn('stroke_rect: unknown canvas id', id); continue; } cv.getContext('2d').strokeRect(x, y, w, h); }
canvas|SET_STROKE_STYLE|set_stroke_style|string:id uint8:r uint8:g uint8:b|{ const cv = canvases.get(id); if(!cv){ console.warn('set_stroke_style: unknown canvas id', id); continue; } cv.getContext('2d').strokeStyle = `rgb(${r},${g},${b})`; }
canvas|SET_STROKE_STYLE_STR|set_stroke_style_str|string:id string:color|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').strokeStyle = color; }
canvas|SET_LINE_WIDTH|set_line_width|string:id float32:width|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').lineWidth = width; }
canvas|BEGIN_PATH|begin_path|string:id|{ const cv = canvases.get(id); if(!cv){ console.warn('begin_path: unknown canvas id', id); continue; } cv.getContext('2d').beginPath(); }
canvas|CLOSE_PATH|close_path|string:id|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').closePath(); }
canvas|MOVE_TO|move_to|string:id float32:x float32:y|{ const cv = canvases.get(id); if(!cv){ console.warn('move_to: unknown canvas id', id); continue; } cv.getContext('2d').moveTo(x, y); }
canvas|LINE_TO|line_to|string:id float32:x float32:y|{ const cv = canvases.get(id); if(!cv){ console.warn('line_to: unknown canvas id', id); continue; } cv.getContext('2d').lineTo(x, y); }
canvas|STROKE|stroke|string:id|{ const cv = canvases.get(id); if(!cv){ console.warn('stroke: unknown canvas id', id); continue; } cv.getContext('2d').stroke(); }
canvas|FILL|fill|string:id|{ const cv = canvases.get(id); if(!cv){ console.warn('fill: unknown canvas id', id); continue; } cv.getContext('2d').fill(); }
canvas|ARC|arc|string:id float32:x float32:y float32:radius float32:start_angle float32:end_angle|{ const cv = canvases.get(id); if(!cv){ console.warn('arc: unknown canvas id', id); continue; } cv.getContext('2d').arc(x, y, radius, start_angle, end_angle); }
canvas|FILL_TEXT|fill_text|string:id string:text float32:x float32:y|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').fillText(text, x, y); }
canvas|FILL_TEXT_F|fill_text_f|string:id string:fmt float32:val float32:x float32:y|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').fillText(fmt.replace('%f', val.toFixed(2)), x, y); }
canvas|FILL_TEXT_I|fill_text_i|string:id string:fmt int32:val float32:x float32:y|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').fillText(fmt.replace('%d', val), x, y); }
canvas|SET_FONT|set_font|string:id string:font|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').font = font; }
canvas|SET_TEXT_ALIGN|set_text_align|string:id string:align|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').textAlign = align; }
canvas|DRAW_IMAGE|draw_image|string:id string:img_id float32:x float32:y|{ const cv = canvases.get(id); const img = images.get(img_id); if(cv && img) cv.getContext('2d').drawImage(img, x, y); }
canvas|TRANSLATE|translate|string:id float32:x float32:y|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').translate(x, y); }
canvas|ROTATE|rotate|string:id float32:angle|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').rotate(angle); }
canvas|SCALE|scale|string:id float32:x float32:y|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').scale(x, y); }
canvas|SAVE|save|string:id|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').save(); }
canvas|RESTORE|restore|string:id|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').restore(); }
canvas|LOG_CANVAS_INFO|log_canvas_info|string:id|{ const cv = canvases.get(id); if(!cv){ console.warn('log_canvas_info: unknown canvas id', id); continue; } console.log('Canvas', id, 'size:', cv.width, 'x', cv.height); }
canvas|SET_GLOBAL_ALPHA|set_global_alpha|string:id float32:alpha|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').globalAlpha = alpha; }
canvas|SET_LINE_CAP|set_line_cap|string:id string:cap|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').lineCap = cap; }
canvas|SET_LINE_JOIN|set_line_join|string:id string:join|{ const cv = canvases.get(id); if(cv) cv.getContext('2d').lineJoin = join; }
canvas|SET_SHADOW|set_shadow|string:id float32:blur float32:off_x float32:off_y string:color|{ const cv = canvases.get(id); if(cv) { const ctx = cv.getContext('2d'); ctx.shadowBlur = blur; ctx.shadowOffsetX = off_x; ctx.shadowOffsetY = off_y; ctx.shadowColor = color; } }

# ------------------------------------------------------------------------------
# INPUT
# ------------------------------------------------------------------------------
input|INIT_KEYBOARD|init_keyboard||{ window.addEventListener('keydown', e => { if(mod.instance.exports.webcc_on_keydown) mod.instance.exports.webcc_on_keydown(e.keyCode); }); window.addEventListener('keyup', e => { if(mod.instance.exports.webcc_on_keyup) mod.instance.exports.webcc_on_keyup(e.keyCode); }); }
input|INIT_MOUSE|init_mouse|string:element_id|{ const el = elements.get(element_id) || document; el.addEventListener('mousedown', e => { if(mod.instance.exports.webcc_on_mousedown) mod.instance.exports.webcc_on_mousedown(e.button, e.offsetX, e.offsetY); }); el.addEventListener('mouseup', e => { if(mod.instance.exports.webcc_on_mouseup) mod.instance.exports.webcc_on_mouseup(e.button, e.offsetX, e.offsetY); }); el.addEventListener('mousemove', e => { if(mod.instance.exports.webcc_on_mousemove) mod.instance.exports.webcc_on_mousemove(e.offsetX, e.offsetY); }); }
input|REQUEST_POINTER_LOCK|request_pointer_lock|string:id|{ const el = elements.get(id) || document.body; el.requestPointerLock(); }
input|EXIT_POINTER_LOCK|exit_pointer_lock||{ document.exitPointerLock(); }

# ------------------------------------------------------------------------------
# SYSTEM
# ------------------------------------------------------------------------------
system|LOG|log|string:msg|{ console.log(msg); }
system|WARN|warn|string:msg|{ console.warn(msg); }
system|ERROR|error|string:msg|{ console.error(msg); }
system|SET_MAIN_LOOP|set_main_loop|string:func_name|{ const fn = mod.instance.exports[func_name]; if(!fn){ console.error('set_main_loop: export not found', func_name); continue; } const loop = (t) => { fn(t); requestAnimationFrame(loop); }; requestAnimationFrame(loop); }
system|SET_TITLE|set_title|string:title|{ document.title = title; }
system|RELOAD|reload||{ location.reload(); }
system|OPEN_URL|open_url|string:url|{ window.open(url, '_blank'); }
system|REQUEST_FULLSCREEN|request_fullscreen|string:id|{ const el = elements.get(id) || document.body; el.requestFullscreen().catch(console.error); }

# ------------------------------------------------------------------------------
# STORAGE (LocalStorage)
# ------------------------------------------------------------------------------
storage|SET_ITEM|set_item|string:key string:value|{ localStorage.setItem(key, value); }
storage|REMOVE_ITEM|remove_item|string:key|{ localStorage.removeItem(key); }
storage|CLEAR|clear||{ localStorage.clear(); }

# ------------------------------------------------------------------------------
# AUDIO
# ------------------------------------------------------------------------------
audio|CREATE_AUDIO|create_audio|string:id string:src|{ const a = new Audio(src); audios.set(id, a); }
audio|PLAY|play|string:id|{ const a = audios.get(id); if(a) a.play().catch(e => console.warn(e)); }
audio|PAUSE|pause|string:id|{ const a = audios.get(id); if(a) a.pause(); }
audio|SET_VOLUME|set_volume|string:id float32:vol|{ const a = audios.get(id); if(a) a.volume = vol; }
audio|SET_LOOP|set_loop|string:id uint8:loop|{ const a = audios.get(id); if(a) a.loop = (loop !== 0); }
audio|GET_CURRENT_TIME|get_current_time|string:id RET:float|{ const a = audios.get(id); return (a ? (a.currentTime || 0) : 0); }
audio|GET_DURATION|get_duration|string:id RET:float|{ const a = audios.get(id); return (a ? (a.duration || 0) : 0); }

# ------------------------------------------------------------------------------
# WEBSOCKETS
# ------------------------------------------------------------------------------
websocket|CREATE|create|string:id string:url|{ const ws = new WebSocket(url); websockets.set(id, ws); ws.onopen = () => console.log('WS Open', id); ws.onmessage = (e) => console.log('WS Msg', id, e.data); }
websocket|SEND|send|string:id string:msg|{ const ws = websockets.get(id); if(ws && ws.readyState === 1) ws.send(msg); }
websocket|CLOSE|close|string:id|{ const ws = websockets.get(id); if(ws) ws.close(); }

# ------------------------------------------------------------------------------
# IMAGES
# ------------------------------------------------------------------------------
image|LOAD|load|string:id string:src|{ const img = new Image(); img.src = src; images.set(id, img); }

# ------------------------------------------------------------------------------
# WEBGL
# ------------------------------------------------------------------------------
webgl|CREATE_CONTEXT|create_context|string:id string:canvas_id|{ const c = canvases.get(canvas_id) || elements.get(canvas_id); if(c) { const gl = c.getContext('webgl'); contexts.set(id, gl); } }
webgl|CLEAR_COLOR|clear_color|string:id float32:r float32:g float32:b float32:a|{ const gl = contexts.get(id); if(gl) gl.clearColor(r, g, b, a); }
webgl|CLEAR|clear|string:id uint32:mask|{ const gl = contexts.get(id); if(gl) gl.clear(mask); }
webgl|CREATE_SHADER|create_shader|string:ctx_id string:shader_id uint32:type string:source|{ const gl = contexts.get(ctx_id); if(gl) { const s = gl.createShader(type); gl.shaderSource(s, source); gl.compileShader(s); if(!gl.getShaderParameter(s, gl.COMPILE_STATUS)) console.error(gl.getShaderInfoLog(s)); shaders.set(shader_id, s); } }
webgl|CREATE_PROGRAM|create_program|string:ctx_id string:prog_id|{ const gl = contexts.get(ctx_id); if(gl) { const p = gl.createProgram(); programs.set(prog_id, p); } }
webgl|ATTACH_SHADER|attach_shader|string:ctx_id string:prog_id string:shader_id|{ const gl = contexts.get(ctx_id); const p = programs.get(prog_id); const s = shaders.get(shader_id); if(gl && p && s) gl.attachShader(p, s); }
webgl|LINK_PROGRAM|link_program|string:ctx_id string:prog_id|{ const gl = contexts.get(ctx_id); const p = programs.get(prog_id); if(gl && p) { gl.linkProgram(p); if(!gl.getProgramParameter(p, gl.LINK_STATUS)) console.error(gl.getProgramInfoLog(p)); } }
webgl|BIND_ATTRIB_LOCATION|bind_attrib_location|string:ctx_id string:prog_id uint32:index string:name|{ const gl = contexts.get(ctx_id); const p = programs.get(prog_id); if(gl && p) gl.bindAttribLocation(p, index, name); }
webgl|USE_PROGRAM|use_program|string:ctx_id string:prog_id|{ const gl = contexts.get(ctx_id); const p = programs.get(prog_id); if(gl && p) gl.useProgram(p); }
webgl|CREATE_BUFFER|create_buffer|string:ctx_id string:buf_id|{ const gl = contexts.get(ctx_id); if(gl) { const b = gl.createBuffer(); buffers.set(buf_id, b); } }
webgl|BIND_BUFFER|bind_buffer|string:ctx_id uint32:target string:buf_id|{ const gl = contexts.get(ctx_id); const b = buffers.get(buf_id); if(gl && b) gl.bindBuffer(target, b); }
webgl|BUFFER_DATA|buffer_data|string:ctx_id uint32:target uint32:data_ptr uint32:data_len uint32:usage|{ const gl = contexts.get(ctx_id); if(gl) { const data = new Uint8Array(memory.buffer, data_ptr, data_len); gl.bufferData(target, data, usage); } }
webgl|ENABLE_VERTEX_ATTRIB_ARRAY|enable_vertex_attrib_array|string:ctx_id uint32:index|{ const gl = contexts.get(ctx_id); if(gl) gl.enableVertexAttribArray(index); }
webgl|ENABLE|enable|string:ctx_id uint32:cap|{ const gl = contexts.get(ctx_id); if(gl) gl.enable(cap); }
webgl|UNIFORM_1F|uniform_1f|string:ctx_id string:prog_id string:name float32:val|{ const gl = contexts.get(ctx_id); const p = programs.get(prog_id); if(gl && p) { const loc = gl.getUniformLocation(p, name); gl.uniform1f(loc, val); } }
webgl|VERTEX_ATTRIB_POINTER|vertex_attrib_pointer|string:ctx_id uint32:index int32:size uint32:type uint8:normalized int32:stride int32:offset|{ const gl = contexts.get(ctx_id); if(gl) gl.vertexAttribPointer(index, size, type, normalized !== 0, stride, offset); }
webgl|DRAW_ARRAYS|draw_arrays|string:ctx_id uint32:mode int32:first int32:count|{ const gl = contexts.get(ctx_id); if(gl) gl.drawArrays(mode, first, count); }
